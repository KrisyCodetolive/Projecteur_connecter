<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âtudiant</title>
</head>
<body>
    <h1>Espace ‚Äì √âtudiant</h1>

    <p>
        Salut <strong><span id="name"></span></strong>, tu es connect√© √† ton espace utilisateur.
    </p>

    <p>
        Statut Peer : <span id="peer-status" style="color: orange;">Connexion‚Ä¶</span>
    </p>

    <button id="btn">Envoyer une demande de diffusion</button>

    <!-- Librairies -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        const nameEtud = prompt("Entrez votre nom") || "√âtudiant";
        document.getElementById("name").textContent = nameEtud;

        const peerStatus = document.getElementById('peer-status');

        // Socket.IO
        const Socket = io();

        // PeerJS
        const myPeer = new Peer(undefined, {
            host: location.hostname,
            port: location.port || 3001,
            path: '/peerjs',
            secure: location.protocol === 'https:'
        });

        // =========================
        // Status PeerJS
        // =========================
        myPeer.on('open', (id) => {
            console.log('‚úÖ Peer connect√© :', id);
            peerStatus.textContent = 'Connect√©';
            peerStatus.style.color = 'green';

            // Envoyer une demande √† l'admin
            document.getElementById("btn").addEventListener('click', () => {
                const demande = {
                    name: nameEtud,
                    PeerId: id,
                    SocketId: Socket.id
                };
                Socket.emit('Demande', demande);
                console.log('üì® Demande envoy√©e :', demande);
            });
        });

        myPeer.on('error', (err) => {
            console.error('‚ùå Erreur PeerJS :', err);
            peerStatus.textContent = 'Erreur';
            peerStatus.style.color = 'red';
        });

        myPeer.on('disconnected', () => {
            console.warn('üîÅ Peer d√©connect√©, reconnexion‚Ä¶');
            peerStatus.textContent = 'Reconnexion‚Ä¶';
            peerStatus.style.color = 'orange';
            myPeer.reconnect();
        });

        myPeer.on('close', () => {
            console.warn('‚ö†Ô∏è Connexion Peer ferm√©e');
            peerStatus.textContent = 'D√©connect√©';
            peerStatus.style.color = 'gray';
        });

        // =========================
        // R√©ception de l'autorisation de l'admin
        // =========================
        Socket.on('RpAdmis', (adminPeerId) => {
            console.log('‚úÖ Autorisation re√ßue de l‚Äôadmin :', adminPeerId);

            navigator.mediaDevices.getDisplayMedia({ video: true, audio: false })
                .then((stream) => {
                    console.log('üé• Capture √©cran d√©marr√©e');

                    // Envoi du stream au Peer admin
                    const call = myPeer.call(adminPeerId, stream);

                    call.on('error', (err) => {
                        console.error('‚ùå Erreur lors de l‚Äôappel PeerJS :', err);
                    });

                })
                .catch((error) => {
                    console.error('‚ùå Erreur lors de la capture √©cran :', error);
                });
        });
    </script>
</body>
</html>
